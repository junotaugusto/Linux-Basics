# Guia Prático: Criando uma Jaula SFTP com chroot no SSH

**DISCLAIMER:** Primeiramente, a ideia aqui é utilizar um exemplo específico para *entender melhor o conceito de chroot*. Este modelo não garante a segurança do seu sistema e deve apenas ser utilizado para aprendizado.

Vale lembrar também que existem diversas maneiras de uso do chroot para isolar o sistema. Esta é apenas uma delas. É fundamental entender também que, embora o `chroot` seja um conceito poderoso e o avô do isolamento de processos, ele tem limitações. Um processo rodando como root dentro de uma jaula pode, sob certas condições, encontrar maneiras de "escapar".

Desta forma, existem tecnologias avançadas e mais atuais inspiradas no chroot, como `Containers (Docker, Podman etc)` por exemplo. Mas este não é o assunto por enquanto.

O objetivo principal do chroot é sempre o mesmo: aplicar o `Princípio da Defesa em Profundidade` e o `Princípio do Menor Privilégio`.

Se um componente do seu sistema precisa apenas de acesso a uma pequena parte dos recursos, não há razão para deixá-lo "ver" o sistema inteiro. `chroot` é uma das ferramentas clássicas para impor essa limitação.

Dito isso, vamos ao nosso exemplo de criação de uma jaula SFTP com chroot no SSH.

## 1. Objetivo

Este guia detalha o passo a passo para configurar um ambiente seguro onde um usuário pode se conectar ao servidor via **SFTP (SSH File Transfer Protocol)** e ser automaticamente aprisionado (chroot) em um diretório específico. 

O resultado é um usuário que pode apenas transferir arquivos para uma pasta designada, sem NENHUMA visibilidade ou acesso ao resto do sistema de arquivos do servidor.

Esta é a implementação prática da ideia de usar o `chroot` para proteger o serviço SSH, utilizando a funcionalidade nativa do **OpenSSH Server**. 

## 2. O Cenário

Vamos implementar uma solução para o seguinte caso de uso:

* **Necessidade:** Conceder acesso a um desenvolvedor externo, de nome `joao`, para que ele possa enviar e receber arquivos de um projeto.

* **Requisito de Segurança:** O usuário `joao` não pode, sob nenhuma hipótese, executar comandos remotamente, navegar por outros diretórios do sistema ou ler arquivos de configuração. Seu acesso deve ser estritamente para transferência de arquivos e restrito a um diretório específico.

## 3. Passo a Passo da Implementação

### Passo 1: Criação do Grupo e do Usuário

É uma boa prática gerenciar usuários com acesso restrito através de um grupo específico.

1.  **Crie um grupo para usuários SFTP:**
```bash
    sudo groupadd sftpusers
```

2.  **Crie o usuário `joao` e adicione-o ao novo grupo:**
```bash
    # Opções:
    # -g sftpusers: Define o grupo primário.
    # -d /srv/jails/joao: Define um "home directory" virtual.
    # -s /sbin/nologin: Impede que o usuário tenha um shell de login interativo.
    sudo useradd -g sftpusers -d /srv/jails/joao -s /sbin/nologin joao
```

3.  **Defina uma senha para o novo usuário:**
```bash
    sudo passwd joao
```

### Passo 2: Preparação da Estrutura da Jaula (Jail)

Esta é a parte mais crítica e onde a maioria dos erros acontece. As permissões do diretório da jaula precisam ser exatas.

1.  **Crie o diretório base da jaula e a pasta de trabalho:**
```bash
    # Diretório que servirá como a raiz ('/') para o usuário
    sudo mkdir -p /srv/jails/joao

    # Diretório onde o usuário poderá de fato escrever arquivos
    sudo mkdir /srv/jails/joao/projeto
```

2.  **Ajuste as Permissões – A Regra de Ouro:**
    O OpenSSH é muito rigoroso com a segurança da jaula. A regra é: **O diretório-base da jaula e todos os seus diretórios-pai na hierarquia DEVEM pertencer ao usuário `root` e não podem ter permissão de escrita para outros usuários.**

```bash
    # A base da jaula DEVE pertencer ao root.
    sudo chown root:root /srv/jails/joao

    # O usuário não pode ter permissão de escrita na sua própria raiz. 755 é o ideal.
    sudo chmod 755 /srv/jails/joao

    # A pasta de trabalho interna DEVE pertencer ao usuário para que ele possa escrever nela.
    sudo chown joao:sftpusers /srv/jails/joao/projeto
```

### Passo 3: Configuração do Servidor SSH (`sshd_config`)

Agora, vamos instruir o `sshd` a usar a jaula que preparamos.

1.  **Abra o arquivo de configuração com um editor:**
```bash
    sudo nano /etc/ssh/sshd_config
```

2.  **Adicione o seguinte bloco no FINAL do arquivo:**
    É importante que seja no final, pois as diretivas `Match` são aplicadas após todas as configurações globais.

```ini
    # --- Configuração da Jaula SFTP ---
    # Aplica as regras seguintes apenas para usuários do grupo 'sftpusers'
    Match Group sftpusers
        
        # Define o diretório raiz da jaula para o usuário conectado.
        # A variável %u é automaticamente substituída pelo nome do usuário (ex: 'joao').
        ChrootDirectory /srv/jails/%u
        
        # Força o uso do subsistema SFTP interno do SSH, bloqueando a execução de shell.
        ForceCommand internal-sftp
        
        # Desabilita tunelamento de porta e X11, que não são necessários e aumentam a superfície de ataque.
        AllowTcpForwarding no
        X11Forwarding no
```

### Passo 4: Validação e Reinicialização do Serviço

1.  **Teste a sintaxe do arquivo de configuração antes de aplicá-lo:**
    Este comando verifica se há erros no arquivo. Se nada for retornado, está tudo certo.
```bash
    sudo sshd -t
```

2.  **Reinicie o serviço SSH para aplicar as alterações:**
```bash
    sudo systemctl restart sshd
```

## 4. Testando o Resultado

Agora, de outra máquina, tente se conectar como o usuário `joao` usando um cliente SFTP.

```bash
# A sintaxe é sftp usuario@servidor
sftp joao@endereco_do_seu_servidor
```

Após o login bem-sucedido:
* O usuário estará no diretório `/`. Para ele, este é o diretório raiz.
* Se ele executar o comando `ls`, verá apenas a pasta `projeto`.
* Ele poderá entrar em `projeto` (`cd projeto`) e transferir arquivos para lá (`put nome_do_arquivo`).
* Qualquer tentativa de sair da jaula (`cd ..`) ou de listar o conteúdo do sistema real (`ls /etc`) falhará, pois, para a sua sessão, nada disso existe.

Seu objetivo foi alcançado com sucesso!