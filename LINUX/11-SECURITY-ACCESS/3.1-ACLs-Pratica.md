# Tutorial Prático: Gerenciando Permissões com ACLs (Versão Personalizada)

## 1. O Cenário

Vamos simular a configuração de um diretório de projeto compartilhado em um servidor.

* **Diretório do Projeto:** `/srv/projetos/projeto_alpha`
* **Equipes e Necessidades:**
    * **Equipe `desenvolvedores`:** Precisa de controle total (leitura e escrita) sobre o projeto. Seus membros são `Bruno` e `André`.
    * **Equipe `gerentes`:** Precisa de acesso de apenas leitura, para acompanhar o progresso. O membro é `Alfredo`.
    * **Consultora Externa (`Alice`):** Não pertence a nenhuma equipe, mas precisa de acesso de leitura a um **único arquivo** de documentação.
* **Requisito Adicional:** Todos os novos arquivos e pastas criados no diretório do projeto devem herdar automaticamente essas regras de permissão.

Este cenário seria impossível de resolver usando apenas `chmod` e `chown`, tornando-o um caso de uso perfeito para ACLs.

## Passo 0: Preparação do Ambiente

Antes de começar, garanta que o pacote `acl` está instalado no seu sistema (Debian/Ubuntu).

```bash
sudo apt update
sudo apt install acl
```

## Passo 1: Criação dos Grupos e Usuários

Vamos criar as identidades que farão parte do nosso cenário.

```bash
# Criar os grupos
sudo groupadd desenvolvedores
sudo groupadd gerentes

# Criar os usuários com suas pastas home (-m) e shell padrão (-s)
sudo useradd -m -s /bin/bash Bruno
sudo useradd -m -s /bin/bash André
sudo useradd -m -s /bin/bash Alfredo
sudo useradd -m -s /bin/bash Alice

# Adicionar usuários aos seus respectivos grupos
# Bruno e André são desenvolvedores
sudo usermod -aG desenvolvedores Bruno
sudo usermod -aG desenvolvedores André

# Alfredo é gerente
sudo usermod -aG gerentes Alfredo

# Verificar se os usuários estão nos grupos corretos
getent group desenvolvedores
getent group gerentes
```

## Passo 2: Criação da Estrutura de Arquivos

Agora, vamos criar o diretório do projeto e definir as permissões base.

```bash
# Criar a estrutura de diretórios
sudo mkdir -p /srv/projetos/projeto_alpha

# Definir 'Bruno' como dono e 'desenvolvedores' como o grupo principal
sudo chown Bruno:desenvolvedores /srv/projetos/projeto_alpha

# Definir as permissões base: Dono(rwx), Grupo(rwx), Outros(---)
# Isso garante que a equipe de desenvolvedores tenha acesso total
# e que 'outros' (como Alfredo e Alice) não tenham acesso algum por padrão.
sudo chmod 770 /srv/projetos/projeto_alpha

# Criar alguns arquivos de exemplo como o usuário 'Bruno'
sudo -u Bruno touch /srv/projetos/projeto_alpha/codigo.py
sudo -u Bruno touch /srv/projetos/projeto_alpha/documentacao.txt

# Verificar o estado inicial
ls -l /srv/projetos/
# Saída esperada: drwxrwx--- 2 Bruno desenvolvedores ... projeto_alpha
```

Neste ponto, apenas `Bruno` e `André` podem acessar o diretório. `Alfredo` e `Alice` seriam bloqueados.

## Passo 3: Aplicando as Permissões com ACLs

É aqui que a mágica acontece. Vamos adicionar as exceções às regras.

```bash
# 1. Dar permissão de leitura e execução (r-x) para o grupo 'gerentes'
# A permissão 'x' é necessária para que eles possam 'entrar' no diretório.
sudo setfacl -m g:gerentes:rx /srv/projetos/projeto_alpha

# 2. Dar permissão de apenas leitura (r--) para a usuária 'Alice'
# no arquivo de documentação específico.
sudo setfacl -m u:Alice:r /srv/projetos/projeto_alpha/documentacao.txt

# 3. Verificar as ACLs aplicadas
# Note o '+' no final das permissões no 'ls'
ls -l /srv/projetos/
# Saída esperada: drwxrwxr-x+ 2 Bruno desenvolvedores ... projeto_alpha

# Ver os detalhes da ACL no diretório
getfacl /srv/projetos/projeto_alpha
# Saída incluirá:
# user::rwx
# group::rwx
# group:gerentes:r-x  <-- NOSSA REGRA PARA GERENTES
# mask::rwx
# other::---

# Ver os detalhes da ACL no arquivo
getfacl /srv/projetos/projeto_alpha/documentacao.txt
# Saída incluirá:
# user::rw-
# user:Alice:r--        <-- NOSSA REGRA PARA A ALICE
# group::rw-
# mask::rw-
# other::---
```

## Passo 4: Configurando ACLs Padrão (Herança Automática)

Para garantir que novos arquivos herdem essas regras, configuramos as ACLs padrão no diretório principal.

```bash
# Adicionar ACLs padrão (-d) para os grupos no diretório
sudo setfacl -d -m g:desenvolvedores:rwx /srv/projetos/projeto_alpha
sudo setfacl -d -m g:gerentes:rx /srv/projetos/projeto_alpha

# --- TESTE DA HERANÇA ---
# Vamos criar um novo arquivo como o usuário 'André' (um desenvolvedor)
sudo -u André touch /srv/projetos/projeto_alpha/novo_modulo.py

# Agora, vamos checar as permissões do arquivo recém-criado
getfacl /srv/projetos/projeto_alpha/novo_modulo.py
# A saída mostrará que, embora o dono seja 'André' e o grupo 'desenvolvedores',
# uma entrada ACL para 'group:gerentes:r-x' foi AUTOMATICAMENTE adicionada.
# O sistema herdou a regra do diretório pai!
```

## Conclusão

Com este fluxo, você construiu um sistema de permissões flexível e robusto que seria impossível de alcançar com o modelo padrão.

* A equipe de **desenvolvedores (`Bruno`, `André`)** tem controle total.
* A equipe de **gerentes (`Alfredo`)** pode visualizar tudo, mas não pode alterar nada.
* A consultora **`Alice`** tem acesso cirúrgico a um único arquivo.
* O sistema se **mantém organizado** automaticamente graças às ACLs padrão.